/* fuzzes a PCT/SSL/TLS server */
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <netdb.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <ctype.h>
#include <string.h>
#include <sys/signal.h>
#include <arpa/nameser.h>
#include <sys/time.h>
#include <time.h>
#include <errno.h>

#define TIMEOUT 3

char buf[8192];
char buf2[8192];

char init[10][1024];
char second[10][1024];
char third[10][1024];
char fourth[10][1024];

void corruptor(char *buf, int len) {
	        int cb, i, l;
		cb = rand()%15+1; /* bytes to corrupt */
	        for (i=0; i < cb; i++) {
	        l = rand()%len;
	        buf[l] = rand()%256;
}




void diffit() {
        int i;
        printf("Last Packet:\n");
        for (i=0; i < sizeof(buf); i++) {
	                printf(" 0x%x ", buf[i] & 0x000000FF);
	                if ( (i % 16) == 15) printf("\n");
        }
        printf("*****\n");
}



int main (int argc, char **argv) { 

init[0][1024] = 
"\x80\x2B\x01\x00\x02\x00\x12\x00\x00\x00\x10\x01\x00\x80\x07\x00"
"\xC0\x03\x00\x80\x06\x00\x40\x02\x00\x80\x04\x00\x80\x28\x8E\xFC"
"\x90\x05\x6B\x7C\x8F\x9D\x7E\x25\x72\x23\x55\x90\x3A";

char second[0][1024] = 
"\x80\x8A\x02\x01\x00\x80\x00\x00\x00\x80\x00\x00\x04\x46\x3E\x49"
"\x0F\xE3\x29\x44\x1F\x94\x9D\x89\x17\xFA\x8F\xD3\xC5\x4A\x0C\xBA"
"\x3B\x5E\xF6\xCA\x9D\x31\xF6\xFE\xA5\x55\x4A\x3D\x2F\xF2\x9B\x48"
"\x0E\x38\xB7\x5E\x7C\x08\x8C\xAA\x94\x14\xC5\x52\x17\xEB\x84\x22"
"\x5F\x08\xA1\x18\x1A\xAF\xB2\x89\x7F\x06\xB0\xC7\xD8\x03\xEB\x53"
"\xE4\xA9\x5E\x86\x11\x60\x0E\xE1\x4B\xD7\xF7\xCA\x3B\x17\xA8\x64"
"\x64\x09\x07\x8D\xE1\x2F\xCB\xD1\x37\x0E\xF1\x5E\xA2\x05\x28\xAC"
"\xF6\x43\x04\xA7\xCC\xF7\x27\xFB\x3A\x71\xF5\xED\xFC\x84\x50\x35"
"\x14\xDB\x1E\x1D\x08\xDD\x63\xFE\xB0\xFE\x41\xBD";

char third[0] = 
"\x80\x21\xA6\x4E\x91\xC1\x35\x81\x5A\x01\x95\xD3\xAC\xF2\x86\xB7"
"\x37\x4F\x69\x17\xF5\x38\xAC\x57\xBB\x64\xA3\x7B\x04\xA1\xCC\xF2"
"\x94\x57\xD0";


char fourth[0] = 
"\x80\x98\x44\xE1\x2B\x94\x7B\x45\xBC\x2E\x7A\x6B\xCC\x36\xAC\xA4"
"\xC8\x2C\x1C\x6F\x00\xCA\x26\x5A\xC6\xE1\x39\x82\xD3\x0C\x7F\x16"
"\x87\xE8\xAE\x28\x88\x1A\xC8\x87\xCC\xC5\x6F\x39\xFA\x87\x01\x78"
"\x17\xAC\x54\x29\xE2\xA2\x74\x74\xE6\x9E\xEE\x58\xE7\x40\x03\xFA"
"\x16\xDC\x12\x5A\x3B\x07\xC0\x13\xF2\xE5\x16\x0E\x61\x73\xE7\x27"
"\xAD\x40\x70\x6D\xDB\xE5\x19\x95\x4A\x3F\x3D\xA7\x4E\x44\xEC\x87"
"\x7C\xE8\xD3\x24\x47\x11\xAF\x7F\x80\xD6\x01\x94\x17\x2B\x08\xCF"
"\x8B\xEE\x0D\x83\x65\xE8\x3A\x16\xED\x1D\x51\xFB\xFB\x80\x0C\x0C"
"\xCC\x23\xDC\x1B\xE3\xE4\x04\xDC\x72\xE3\x4C\xDA\x1D\xC3\x3C\x42"
"\xBA\xDB\xC1\xB9\xD4\x49\xFE\xDC\x90\xE8";


/* ------------------------------------------------------------- */

init[1][0] =
"\x80\x2B\x01\x00\x02\x00\x12\x00\x00\x00\x10\x01\x00\x80\x07\x00"
"\xC0\x03\x00\x80\x06\x00\x40\x02\x00\x80\x04\x00\x80\x53\x5A\x7B"
"\xFB\x10\xE2\x92\xE0\xCE\xDD\x06\xC9\x9F\x9B\xE7\x42";

char second[1] = 
"\x80\x8A\x02\x01\x00\x80\x00\x00\x00\x80\x00\x00\x28\x92\xC8\x14"
"\x40\x85\x94\x48\xFE\x9B\x60\xED\x13\xD7\xD9\x5A\xC8\x31\x3C\x16"
"\xF1\x05\xF0\xD8\x57\x61\xB7\x3F\xA1\xAA\xC4\x84\xA4\x90\x3E\x81"
"\xE5\xFF\x6B\x12\x87\xEE\x18\x7B\xF0\xEE\x4A\xE4\x11\x0E\xC0\x91"
"\x9E\x22\xFF\x2C\xD4\xE4\x08\x3B\xC0\xCB\x11\xDF\xA4\x6A\x8B\xF8"
"\x6B\x58\xA7\x66\xF6\xBE\x93\xA8\xD8\xCE\xA2\x70\x1C\x01\xD8\x4F"
"\xAF\xC9\x65\x1A\xC0\x8D\x63\x4B\xFC\x47\x55\x37\x84\x7A\x25\x98"
"\x0F\xDF\x4B\x37\xB6\x3F\x58\xB9\xF5\xF6\xFC\x35\xA5\x3D\x54\xBB"
"\x42\xB0\x6F\xE7\xDC\x8A\xD7\x2D\x11\x33\x5D\x0B";

char third[1] = 
"\x80\x21\x8A\x20\xFA\x65\xD2\x56\xC5\x94\xA4\x75\xC6\x63\x41\xFC"
"\x69\xF7\x3C\x65\x10\x03\x15\xB6\x41\xC1\xBF\x82\xE0\xCD\x93\x30"
"\x84\x20\x4A";

char fourth[1] = 
"\x80\xAB\x72\x92\xCE\x23\xF4\x66\xE8\xF6\x79\x0E\x5B\x59\x7E\x7E"
"\xF7\x9E\x88\x49\xD2\x2F\x64\xB1\xAB\x45\x63\x9A\x87\x97\x77\xE1"
"\xEA\xE1\xB3\x3A\x0B\xCA\x89\xAD\x80\x21\x0E\xD9\x59\x9F\xFB\xFE"
"\xD2\x2F\x76\x22\x86\xE9\xD3\x2F\x4B\xE1\x75\xD8\xA0\xAB\x82\x19"
"\x63\xC1\xF8\xAE\x9E\xB5\x39\x0A\xE7\x42\x5F\xB7\xBF\x1F\x9D\x03"
"\x6A\xC7\x71\xED\x4C\xDB\x78\xAA\x9B\x44\xA2\xBD\x2B\x80\x13\x2D"
"\x67\x08\x3B\xC3\x94\x87\xFD\xCE\x1A\x08\x2B\xD3\x96\xF3\xD0\x98"
"\x5F\x89\xE2\x26\x9B\xD1\xEA\x91\x69\x20\x49\x00\xCD\x09\x4F\xC6"
"\xBF\x66\x54\x57\xE2\x63\x47\xF2\xCA\x50\x5C\xE7\xF7\x74\xAA\xC7"
"\x0F\x17\xBA\x12\x0C\xDF\x55\xA9\xDD\x9D\x02\x3A\x0D\xE8\x26\xAE"
"\x66\x6C\x7F\x98\xAC\xE6\xB7\x08\x5C\xD1\x6F\x01\xCD";

/* ------------------------------------------------------------- */

init[2][0] = 
"\x80\x2B\x01\x00\x02\x00\x12\x00\x00\x00\x10\x01\x00\x80\x07\x00"
"\xC0\x03\x00\x80\x06\x00\x40\x02\x00\x80\x04\x00\x80\xB3\xF5\xA9"
"\xC2\xD1\x87\xBF\x59\xBD\xF4\x8B\xD5\x2B\xCD\xA5\xB8";


char second[2] = 
"\x80\x8A\x02\x01\x00\x80\x00\x00\x00\x80\x00\x00\xBB\x19\x51\x9E"
"\x8D\x79\x5E\x1E\xA6\xD2\xB8\xE5\x39\x69\x94\x70\xFF\x01\x3E\xA4"
"\x9C\xA3\x1E\x1E\xC3\xA4\x8E\x52\xFF\x72\xBB\x72\x55\x54\x75\xC6"
"\xF2\x5E\x9C\x04\x6D\xAF\x9D\xAA\x9B\xD7\xED\x84\xE8\x47\x6F\xA5"
"\xF7\x2B\xE5\x09\x28\x08\x08\x3F\x7A\xC7\x22\x6B\x9B\xCA\x4F\x0E"
"\x85\xBD\xCE\xD1\x38\xA6\x8C\x1F\x63\x13\xA4\xD4\xD0\xEA\x29\x45"
"\x66\xC0\x47\xE0\x84\xAE\x46\xA5\x72\xB8\x60\x8F\x3B\x32\x36\x07"
"\xE2\x17\x6D\x9A\xB3\x86\x75\xE1\x52\xDD\x77\x9F\x9C\x92\x68\x6F"
"\x7D\x62\xC7\x20\xC8\xE3\xDC\x7C\x8F\x54\xD7\x0F";

char third[2] = 
"\x80\x21\xBB\xE5\x7A\xF5\xB4\x8C\x49\x0F\xC4\xF8\x31\xCC\x16\xD4"
"\xEA\x1C\x9B\xEF\xB8\x55\xF5\x54\x44\x8C\x2C\x92\x1F\xFC\x9D\x91"
"\x42\x4A\xD7";


char fourth[2] = "END";



/* ------------------------------------------------------------- */


init[3][0] = 
"\x80\x2B\x01\x00\x02\x00\x12\x00\x00\x00\x10\x01\x00\x80\x07\x00"
"\xC0\x03\x00\x80\x06\x00\x40\x02\x00\x80\x04\x00\x80\x30\x66\xA6"
"\x5F\x7B\xC1\x28\x46\xFE\x24\x4B\x09\xF9\x7F\xC5\x4A";

char second[3] = 
"\x80\x8A\x02\x01\x00\x80\x00\x00\x00\x80\x00\x00\x36\xF2\x7A\xD1"
"\x66\x29\xDF\x6E\xBF\x41\xC9\x92\x69\xD6\x0F\xA4\x06\x20\x0C\x0D"
"\x7A\x2D\xE2\x59\x84\x5D\x3B\x04\x7E\xA5\x53\x87\x68\x83\xBE\xAD"
"\xAF\xC5\x83\xA6\x80\x9E\xC8\xF4\x7B\x55\xE0\x97\xA1\xFC\x43\x5C"
"\xF8\x25\x70\x3E\xC9\xFA\x07\x07\xC4\xBB\x2F\x98\xA7\xDD\x53\xB8"
"\x25\xFD\x67\x07\xA8\x5C\x20\x4C\x9E\x6F\xFC\xD0\x5D\x1C\xE4\xD0"
"\xB7\x09\xBD\x76\x3D\x61\xE6\x8E\x0C\xEE\xFD\xDA\xC8\x79\xFE\x94"
"\xF9\x66\x98\xDC\x25\x6E\xF6\x9E\xAC\xDC\x02\xBD\x75\xD4\x85\x6E"
"\x0D\x80\x72\xEE\x85\x06\x3C\x1D\x25\xA4\xC2\xEB";

char third[3] = 
"\x80\x21\x95\x22\x69\x42\xE9\xB7\xB2\x60\x40\x96\xBF\x45\xE1\x65"
"\xCC\x1F\x89\x1C\x20\x9A\x83\x6C\x05\xAE\xCB\x7A\xAF\xEA\x0D\x61"
"\x5B\x9A\xE2";

char fourth[3] = 
"\x80\x69\x63\xC9\x1A\x5C\xAC\xBD\xD3\x1C\x0F\x42\x22\x27\x76\x6A"
"\xBF\x8B\xF5\xD6\xE9\xE1\x20\x53\x7F\xC5\xDA\xE7\x8D\x66\xF3\xB5"
"\xCC\x3D\xB6\x62\xB9\x32\x50\x91\x66\x17\x94\x5D\x87\x59\x68\x83"
"\x8A\x05\xF8\x9D\x9A\x51\x01\x9D\xFE\x6E\x21\x89\xDB\x09\x91\x8B"
"\x67\x3A\x3B\xB4\x6D\x74\xBF\x54\x5D\xAC\xEC\x95\x9A\x95\xE4\xDA"
"\x8D\x6E\xDA\x78\x48\xE0\x43\x5B\xDE\xB4\x07\xB4\x6B\x38\x94\x56"
"\xE6\x03\x0E\x21\x7B\x62\x87\x5D\x33\x1C\x6D";


/* ------------------------------------------------------------- */


init[4][0] = 
"\x80\x8A\x02\x01\x00\x80\x00\x00\x00\x80\x00\x00\x62\x42\x90\x86"
"\x72\xEE\x21\xBA\x50\xC8\xE0\x11\xE1\xB4\xEE\xDD\x66\xB6\x17\x40"
"\x54\xC4\x6D\xE3\x4A\x6E\xC3\x21\xDE\xB3\xC2\x95\x57\x77\x34\x84"
"\xD9\xF0\x68\xF2\xDD\x20\xDD\xA4\x55\x07\xB6\x95\x13\xBF\xE7\xEF"
"\x35\x71\xAE\x88\x7E\x05\xDD\x51\xC3\xC8\x77\xCA\x9F\x31\x31\xCA"
"\x39\xF2\x92\xCB\x92\x51\xE7\x95\x6F\x77\x2C\xDE\x34\x1F\x76\x59"
"\x1E\x99\x2B\x57\x08\x05\x81\xCC\x24\x5B\x09\xF8\x37\xFD\xA8\xCB"
"\x14\xD3\xC9\xF7\x00\xF2\x69\x8E\xEA\x0F\x79\x17\x78\x7E\x06\x13"
"\xC2\x14\x64\x0C\xBC\x8F\x77\x17\xA1\xB0\xE6\x28";

char second[4] = 
"\x80\x21\xF4\xEA\x42\x85\x01\xEA\xA0\x86\x11\x2D\xAE\x92\x17\x56"
"\x97\x8F\xE9\x79\x00\xF0\x09\x96\x8E\xBF\x6D\x1F\x6B\x59\x6D\xB4"
"\x4C\xDE\x57";

char third[4] =
"\x80\xB0\xF3\xF7\xCE\x50\x9A\x29\x29\xD2\x80\x1B\x67\x36\x52\xBD"
"\x90\xC2\xCB\x57\x56\x25\x37\x05\xD6\x7C\x90\x34\x98\x7A\xAC\x7A"
"\xA6\x92\x63\xAC\x0A\xE7\xF7\x10\xB1\xAD\x4A\x20\x78\x3D\xC9\x9B"
"\xB9\x72\xD5\x5E\xE6\x97\xE9\x3A\xB5\x87\xD1\x46\xA2\xB4\x38\x34"
"\xA4\xE2\xF2\xE0\xC8\xBF\xC9\x8D\xFD\x24\xDD\x80\x3A\x1B\xE7\xBA"
"\xBF\xCD\x7F\x93\xCA\xF1\x40\x31\x1A\x06\x36\x0E\xA2\xE9\xD8\x2D"
"\x57\x4A\xCD\x5C\x06\xC4\xAE\x9F\xB5\xBA\x94\x76\x92\x86\x8D\x07"
"\x1E\x46\x68\x52\x1C\x49\x2B\xBB\xEC\x21\x63\x72\x2F\x04\xA4\xAC"
"\xB2\xE4\xD5\xDA\xA6\xD3\x29\x00\x1E\x00\x3F\xDC\xC1\x05\x8D\xA3"
"\x0F\xD9\xFE\x22\x81\x71\x2F\xDD\xCC\x49\xC3\xB1\x6E\x46\x01\xCA"
"\x36\x4F\xC8\xA6\x1A\xD9\xC0\xC1\x75\xFB\x88\x4B\xF0\xE8\x2D\x7F"
"\x95\x12";

char fourth[4] = "END";

/* ------------------------------------------------------------- */


char init[5] = 
"\x16\x03\x01\x00\x41\x01\x00\x00\x3D\x03\x01\x40\x81\x30\x57\x1C"
"\xC3\xDF\x33\x0A\x8E\x65\x21\x10\xB6\x18\xE1\x35\x83\x91\xE4\xB9"
"\xAB\xD0\x9B\xA5\xDF\xBE\x7F\x94\x88\x5A\xB2\x00\x00\x16\x00\x04"
"\x00\x05\x00\x0A\x00\x09\x00\x64\x00\x62\x00\x03\x00\x06\x00\x13"
"\x00\x12\x00\x63\x01\x00";

char second[5] = 
"\x16\x03\x01\x00\x86\x10\x00\x00\x82\x00\x80\x0E\x5B\x6F\xC2\xAA"
"\xA9\xDA\x26\x95\x59\x60\x25\xB9\x11\x8A\xC2\xFE\x21\x56\x81\x21"
"\xDA\x74\x64\x78\x97\xF9\x2C\x2D\xAE\x36\xD5\x3E\x83\x17\xA9\x10"
"\xA6\x9B\xF8\xAD\xB6\x58\x50\x71\x7E\xBE\xBF\x12\x00\x9D\x4A\x72"
"\x9F\x51\x6B\x8D\x6E\x6E\x24\x53\x74\x89\x1E\xED\xE8\xEF\x16\xED"
"\xA7\x39\xF9\xE7\x58\xA7\x01\xA7\x70\x5B\x75\x4B\xE2\x69\x81\x01"
"\x6A\xB5\xE1\x36\xF3\xF8\x09\x8D\x75\xD1\x5A\x7E\x7C\x32\x4A\xC2"
"\x65\x77\xF4\xBB\x39\xBC\xAF\xC1\xAD\xFF\xBC\x0F\x0B\xCA\x61\x50"
"\xDD\xE5\xE4\x1B\x43\x2B\x5B\xEA\xEA\x27\x7C\x14\x03\x01\x00\x01"
"\x01\x16\x03\x01\x00\x20\xDD\x9E\xA8\x95\x9D\xEB\xD1\x57\x04\x49"
"\xEB\xC9\x9C\x39\x6B\x9E\x17\xE9\xDF\x83\xCC\x65\x55\xE6\xFB\xA0"
"\x42\x70\x56\x24\xE4\xDF";


char third[5] = 
"\x17\x03\x01\x00\x98\x29\x54\xA0\x18\xF3\x08\x26\x7D\x1F\x0F\xF7"
"\x07\x44\x79\x81\x6B\xCC\x26\x93\x92\x08\x32\x0A\xB7\x00\x82\x27"
"\xF3\xF9\x0D\xDE\xF6\xB2\x89\x96\x1D\x27\x14\xBD\x98\x38\xCB\x3A"
"\x21\x9F\x18\x79\x23\x2C\xA0\x68\x13\x57\xDB\xBA\x93\xAD\xED\x3A"
"\x5F\xC7\xB2\x35\xAF\x80\xB4\x57\x63\x60\x9E\x09\x29\xFB\x20\xDE"
"\xE2\x28\x99\x35\xC9\xE3\x8B\x85\xE5\x91\x09\x97\x1E\x3F\xC9\xD6"
"\xAF\x33\xB0\x9F\x7E\x18\x3E\x4A\x85\xE2\xC1\x72\x0B\xB7\x1B\x2A"
"\x73\xAD\x6B\xB6\x6F\x64\xA4\xC5\x12\x6E\xBD\x6F\x3E\xAD\xEA\xB6"
"\x35\x6E\x02\x10\xA6\x9E\x1A\x99\x31\x41\xB3\x1D\x75\xC9\xCE\x4A"
"\x25\x07\x17\x9D\xEB\x52\xA5\x41\xEF\xCC\x8D\x5C\xCB";


char fourth[5] = "END";


/* ------------------------------------------------------------- */


char init[6] = 
"\x16\x03\x01\x00\x41\x01\x00\x00\x3D\x03\x01\x40\x81\x30\x5A\x7C"
"\xA4\x13\x57\x9F\x71\x0F\x8D\x2C\xB0\xA7\x18\xC6\x3B\xC8\x11\xE6"
"\x1D\x79\xEC\x90\x4C\x92\x4B\xA4\x9B\xD2\xF6\x00\x00\x16\x00\x04"
"\x00\x05\x00\x0A\x00\x09\x00\x64\x00\x62\x00\x03\x00\x06\x00\x13"
"\x00\x12\x00\x63\x01\x00";

char second[6] = 
"\x16\x03\x01\x00\x86\x10\x00\x00\x82\x00\x80\x05\x63\x7F\xE7\xC5"
"\x7E\x41\xC3\x88\x32\x5F\x39\xD1\x70\xE0\xA2\x28\x61\x08\xFB\xF6"
"\x84\xD4\x14\xBD\xEC\xA1\x5E\x9E\x97\x96\x89\xC2\x95\x80\xF8\xBF"
"\xCA\x12\x8B\xBF\x25\x51\x31\x0D\x06\xAF\x28\xF3\xD5\xC2\x6B\x53"
"\x86\xBD\xAA\x10\xCC\xAE\xDB\xDE\xD4\xC1\x98\xD5\x95\xD3\xEA\x0C"
"\x57\xAF\x23\x1B\x03\xB9\x86\x1B\xAB\x84\xF1\x6B\x48\xA2\x35\x3C"
"\x16\x44\x2C\x1A\xC5\xFC\x83\xEA\xE3\x95\x5E\x39\xA6\x9D\x98\x9A"
"\xBE\xCF\x97\x42\x30\x57\x32\x25\xDF\x0C\x46\xAF\xCE\xB9\x28\xB4"
"\x6D\xFD\x7C\x5B\x12\xCC\x58\x2C\x5C\x6B\x58\x14\x03\x01\x00\x01"
"\x01\x16\x03\x01\x00\x20\xFA\xF7\x7A\x3A\xF8\x2A\xDA\xCF\x93\x24"
"\x8F\x5B\xC2\xC5\xC2\x8F\xAA\x15\xF8\xE6\xDD\xCE\x6A\x7B\x25\xFB"
"\x08\x7C\x8C\x69\xFD\xC8";


char third[6] = 
"\x17\x03\x01\x00\xAB\x8A\xE3\x57\xCD\xE0\xCE\x9A\x83\x2D\x2E\x42"
"\xE6\x2A\x34\xDE\xF0\x01\x13\x9D\x76\xD3\xBE\x04\xBA\x10\x66\xBD"
"\xE1\x03\xA2\x18\x80\x7D\x56\x0C\x32\xC1\x17\xB7\x74\x56\x37\x12"
"\x31\xC4\xCF\xB1\x37\x41\xD3\x1C\x24\x21\xEF\x1A\xC2\x93\x77\xC4"
"\x37\xAC\x44\xA6\x25\x6A\xEE\xD0\x5B\x80\x26\x8A\x6B\xD5\xCF\x04"
"\xB4\x5E\x0F\x00\x08\xD5\x65\x8E\xF4\xA2\x84\x0D\x1E\x85\x09\x5E"
"\x4E\xF6\xFA\x5E\xBB\x37\x99\x91\x2C\x3D\x05\x72\xE6\xEE\x44\x21"
"\x1B\xE8\x36\x63\xB9\x84\xA3\x38\xC4\xA4\x8A\xF3\x94\x7B\xA3\x0C"
"\xCA\x11\xDC\x2D\x24\x88\xF2\x27\xB1\x73\xE6\xDA\x81\xC8\xCE\xD5"
"\x4B\xA3\xC3\x95\x65\xCD\x91\x48\xA8\xEA\xE1\x67\x35\x1D\x6C\xBE"
"\x91\x3D\x58\x40\x58\x40\x0F\xC3\x9E\x59\xE1\x30\x8A\x8E\x6E\x1B";

char fourth[6] = "END";


/* ------------------------------------------------------------- */


char init[7] = 
"\x16\x03\x01\x00\x41\x01\x00\x00\x3D\x03\x01\x40\x81\x30\x5D\xBA"
"\xB7\x12\x23\x75\x7F\xFB\xDA\xCA\xA5\xE3\x03\x95\xCE\x4D\xA5\x53"
"\xA8\x84\xD2\xFB\x18\xEB\xD7\xEE\xE4\xE3\x49\x00\x00\x16\x00\x04"
"\x00\x05\x00\x0A\x00\x09\x00\x64\x00\x62\x00\x03\x00\x06\x00\x13"
"\x00\x12\x00\x63\x01\x00";


char second[7] = 
"\x16\x03\x01\x00\x86\x10\x00\x00\x82\x00\x80\x2E\x3B\x38\xD8\x34"
"\x8A\x3B\x38\x7E\xD7\xE4\x81\x26\xA3\x7B\x3F\x21\x25\x90\x31\x75"
"\xC1\x86\x05\x0C\x1C\x50\x0B\xCA\x85\xF6\x97\x7B\xD9\x78\x69\x33"
"\x1B\xE9\x39\x0D\xAE\xBD\xE8\x17\xB1\x81\x0F\x89\x21\x5F\x63\x3C"
"\x86\x31\x1F\x70\x0A\x2B\x1B\xF8\x8A\x85\x50\xA1\x71\x98\xC1\xDB"
"\xF6\xBB\x2A\x5A\x28\x0E\xEE\xE2\xE4\xF1\x11\x5A\xE3\xB0\x16\x56"
"\xAB\x0A\x40\xF7\xA7\x29\xFD\xA8\x42\x90\x94\xA0\x07\x4A\xB4\xED"
"\x2E\x26\x67\x7B\xC6\x3D\xA4\xBD\x10\xD2\x99\x69\x28\x6E\xC8\xEA"
"\x96\x6B\xD8\xAE\x1E\xE0\x50\xE6\xD4\xCC\xA8\x14\x03\x01\x00\x01"
"\x01\x16\x03\x01\x00\x20\xC2\x26\xBD\x57\x7D\x72\x60\x46\x17\x69"
"\x79\x36\x75\x36\x46\x00\xA2\xFD\xEC\xA3\xE7\xF7\xFF\x0F\xFB\x68"
"\x6E\x83\xDD\x6A\x7F\x26";


char third[7] = "END";

char fourth[7] = "END";


/* ------------------------------------------------------------- */

char init[8] = 
"\x16\x03\x01\x00\x41\x01\x00\x00\x3D\x03\x01\x40\x81\x30\x60\x4D"
"\xE2\x73\x93\x2A\x0F\xA9\x48\x66\xA5\x10\x34\xDB\x4C\xC7\x9C\x3B"
"\xFF\x14\x53\xF7\x7F\x0E\xDA\xDC\x3F\x8F\x3C\x00\x00\x16\x00\x04"
"\x00\x05\x00\x0A\x00\x09\x00\x64\x00\x62\x00\x03\x00\x06\x00\x13"
"\x00\x12\x00\x63\x01\x00";

char second[8] = 
"\x16\x03\x01\x00\x86\x10\x00\x00\x82\x00\x80\x5B\xA5\x8A\x75\x76"
"\xED\x1A\xAF\x21\x28\xE6\xF3\x3F\x55\x9C\x3A\xD6\x3A\x2A\x59\x1A"
"\x55\xAF\x82\x28\xF8\x80\x9D\x0C\x6F\x0E\x4E\x3A\x16\x85\x59\xBD"
"\xEA\xF2\x3A\x13\x0E\xB1\xBE\x9A\x91\x46\xF3\x3D\xCC\xD4\x53\x9F"
"\x75\x98\x1C\x3E\xBF\xD7\xB4\x3A\xFA\xFA\xCE\xBC\x4F\x93\x9F\xA1"
"\x49\xD2\x9C\x9D\x8B\xAD\xF8\xE5\x85\xBE\xE0\x1E\xB0\x30\xD7\xF4"
"\xA1\x85\x15\x68\xAC\x1B\x62\x2F\xB1\x7E\x64\xBE\x70\x98\x7A\x2C"
"\xCA\x56\xD2\x1C\xBC\x3C\x18\xC6\x20\x65\xD1\x94\x17\xC4\x26\x06"
"\xD6\x78\x3A\x2B\x94\xA0\x59\x4D\x96\x84\xB2\x14\x03\x01\x00\x01"
"\x01\x16\x03\x01\x00\x20\xC4\xC4\x99\xEF\xF2\x05\x6F\x2F\x34\x05"
"\xCD\xDC\x33\x55\xFB\x43\xEA\xD0\x13\xA0\x28\x4F\xC6\x06\x65\xB1"
"\xA5\x0D\x28\xB3\xDB\xAA";

char third[8] = 
"\x17\x03\x01\x00\x69\x5F\x76\xB4\x98\x7B\x14\x1A\x83\x52\x48\x23"
"\x11\x88\xAC\x0D\x02\x7E\x27\x15\x31\xEF\xD6\xC9\x3B\x29\xA9\xE2"
"\x36\x00\x02\x63\x55\x43\x62\xDC\xE8\xD2\x3C\x7A\xF1\xAB\x26\xEA"
"\xDD\x06\x8E\xE2\x3B\xE8\xE7\x8F\x01\x62\x9F\x74\xF8\x85\xA2\x13"
"\x5E\x1C\xC8\x38\xF6\x3A\xDE\xEB\x35\x2C\x70\x06\x9A\x22\x6F\x2D"
"\xA6\xEF\x81\x24\xE4\xB4\x11\x32\xF5\x7A\x38\x1B\x97\xD1\xE4\x02"
"\xA9\x57\xB2\x69\xC7\x45\x83\x87\x71\x32\x87\x0C\xE5\x69";

char fourth[8] = "END";


/* ------------------------------------------------------------- */

char init[9] = 
"\x16\x03\x01\x00\x41\x01\x00\x00\x3D\x03\x01\x40\x81\x30\x63\xF2"
"\x7B\xC9\x4C\xB5\x8E\x43\x10\xFB\xC7\x5E\xF2\x80\x00\xD0\x64\x98"
"\x43\x96\xA9\x45\x08\x1B\x80\xAD\xBE\x41\x53\x00\x00\x16\x00\x04"
"\x00\x05\x00\x0A\x00\x09\x00\x64\x00\x62\x00\x03\x00\x06\x00\x13"
"\x00\x12\x00\x63\x01\x00";


char second[9] = 
"\x16\x03\x01\x00\x86\x10\x00\x00\x82\x00\x80\xBC\xDA\xEB\x6C\x0E"
"\x5A\xDF\xA4\xCB\x61\xB6\x9C\x63\xFA\xD0\x8D\x9A\x4A\x55\x6E\xAB"
"\xF8\x78\xC5\xED\x16\xCF\xAA\x49\x01\xDF\xCE\x4B\xA7\x33\xE6\xC9"
"\xE0\x6F\x06\x2D\xC3\x2A\x56\xB1\x91\x2E\x33\xE3\xA4\xBD\xB9\x3C"
"\x15\x9D\xB6\x43\xA1\x2B\x69\xDB\xBD\x33\x24\xFE\x39\x56\x7E\xFD"
"\x8E\x3F\x67\x29\xF3\x93\xAD\x19\x77\x05\x62\xC6\x90\xED\x9B\x31"
"\x8B\x99\x7D\xF4\x2C\xD5\x8F\x61\xF0\x4E\x26\xB6\x46\x89\x18\x0E"
"\x7B\x3C\xD0\xAB\x16\x74\xF9\x24\x6D\x25\x1D\x87\x35\xAB\x8D\xB2"
"\xE0\x26\x41\xF3\x3F\x62\xC1\x8E\xA8\x11\x12\x14\x03\x01\x00\x01"
"\x01\x16\x03\x01\x00\x20\x6E\x22\x22\x88\xF0\xAE\x07\x69\x2A\x83"
"\x03\x6A\xA0\x2E\x76\x2E\xC0\x64\x76\xA6\xAF\x1F\xC4\x71\x3A\x1E"
"\x88\x5F\x11\xBD\xDE\x63";

char third[9] = 
"\x17\x03\x01\x00\xB0\xD5\x1C\x60\xF9\xC8\x81\xB8\xDC\x01\x0F\x4C"
"\xB1\xE2\xAB\xF0\x9D\x10\x07\xF8\x3F\xFC\x5D\xDE\xC1\x7D\x5B\xAE"
"\x73\x0C\x6B\x7E\x74\xB9\xAF\xFD\xCF\xA5\xD9\x28\x94\xAB\xB5\xA2"
"\x9C\x76\x37\x06\x55\x91\x14\x95\x98\x3C\x9A\x43\x04\x00\x30\xF0"
"\x40\xBC\xCC\x65\xB6\x34\xF6\x25\x9D\xC2\x07\x03\xF7\x81\x71\x6B"
"\x02\xB1\x31\xC9\xB0\x0F\x4A\xDF\x88\x15\x9E\x4C\x47\x9A\x3A\x73"
"\x63\x5E\xAC\x8F\xD1\xD5\x75\x21\x94\x27\x76\xB5\x91\x9A\x73\x10"
"\x82\x24\x06\x63\x90\x16\x0B\xE6\x81\x52\xE1\x2A\xC8\x91\x76\xAC"
"\xE3\x68\x68\x13\x99\xE6\xE3\x20\x63\xEE\xAD\x71\x55\xEE\x09\xED"
"\xC6\x9E\x6A\x75\x5C\x0A\x73\x2B\x7E\xAC\x61\xE1\x14\xE3\x2C\xCE"
"\xE8\x46\xAE\xA9\xDA\x77\xFA\x40\xFE\x71\x7A\xE3\x56\x54\xE5\x6A"
"\xC7\x62\x4B\xD1\xA3";

char fourth[9] = "END";

/* whew! */




	struct sockaddr_in addr;
	int s, port = 0, first = 1, len, counter, packcounter,packflag,phi, mu, last, seeder;
	char *host = NULL;
	unsigned int seed;
	struct timeval tv;

	printf("Generic Protocol fuzzer [propz to syzop]\n\n");

        if (argc < 3) {
                fprintf(stderr, "Use: %s [ip] [port]\n", argv[0]);
                exit(1);
        }
	

	host = argv[1];
	port = atoi(argv[2]);
	if ((port < 1) || (port > 65535)) {
		fprintf(stderr, "Port out of range (%d)\n", port);
		exit(1);
	}

        memset(&tv, 0, sizeof(tv));
        tv.tv_sec = TIMEOUT;
        tv.tv_usec = 0;


	memset(&addr, 0, sizeof(addr));


	signal(SIGPIPE, SIG_IGN); /* Ignore SIGPIPE */
        counter = 0;
        fprintf(stdout, "Fuzzing...\n");
        while(1) {
	    for (phi=0; init[phi]; phi++) {
                counter++;
	        if ((s = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
		    fprintf(stderr, "Socket error: %s\n", strerror(errno));
		    exit(EXIT_FAILURE);
	        }
                setsockopt(s,SOL_SOCKET,SO_RCVTIMEO,&tv,sizeof(tv));

	        addr.sin_family = AF_INET;
	        addr.sin_port = htons(port);
	        addr.sin_addr.s_addr = inet_addr(host);
	        if (connect(s, (struct sockaddr *)&addr, sizeof(addr)) < 0) {
		    fprintf(stdout, "Unable to connect: %s\n", strerror(errno));
		    if (!first) {
			diffit();
                    }
	        }
	        first = 0;
		
		for (packcounter=0; packcounter < 4; packcounter++) {
		    if (packcounter==0) {
			    memcpy(buf, init[phi], sizeof(init[phi]) - 1); 
			    packflag=1;
	            }
		    if (packcounter==1) {
			    memcpy(buf, second[phi], sizeof(second[phi]) - 1);
			    packflag=1;
	            }
		    if ((packcounter==2) && (third[phi] != "END")) {
			    memcpy(buf, third[phi], sizeof(third[phi]) - 1);
			    packflag=1;
	            }
		    if ((packcounter==3) && (fourth[phi] != "END")) {
			    memcpy(buf, fourth[phi],sizeof(fourth[phi]) - 1);
			    packflag=1;
		    }
		    if (packflag) {
		        if ( (rand() % 4) == 0) corruptor(buf,sizeof(buf) - 1);
	                write(s, buf, sizeof(buf)-1);
                        memset (&buf2, 0, sizeof(buf2));
                        mu=recv(s,buf2,sizeof(buf2),0);
	                if (! mu) {
			   fprintf("no response to last valid packet with counter = (%d)\n",counter);
		           diffit();
		        }	   
		        packflag=0;
		    }
               }
	    close(s);
	    }
        }
	
	exit(EXIT_SUCCESS);
}

